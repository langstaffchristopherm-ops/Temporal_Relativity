% ==============================
% format_macros.tex â€” core packages, macros, page style, and helpers
% (cleaned & compile-safe)

% ---- Release metadata (single source of truth) ----
\IfFileExists{release.tex}{\input{release.tex}}{}%
% Fallbacks if release.tex is missing
\providecommand{\RepoConceptDOI}{10.5281/zenodo.17119049}
\providecommand{\PaperDOI}{10.5281/zenodo.17421413}
\providecommand{\RepoCommit}{abc1234}
\providecommand{\PaperVersion}{v2.0.2}
\providecommand{\PaperLicense}{CC BY 4.0}
\providecommand{\RepoURL}{https://github.com/langstaffchristopherm-ops/Temporal_Relativity}
\providecommand{\RepoGitHubURL}{\RepoURL}
\providecommand{\PaperTitleMain}{Temporal Relativity ($\Delta S = \Delta \tau$)}
\providecommand{\AuthorName}{Christopher Michael Langstaff}
\providecommand{\AuthorNameShort}{C.~Langstaff}
\providecommand{\AuthorORCID}{0009-0000-3960-773X}

% --- Core packages (pdfLaTeX-safe) ---
\usepackage[utf8]{inputenc}%
\usepackage[T1]{fontenc}%
\usepackage{lmodern}%
\usepackage{microtype}%
\usepackage{amsmath,amssymb}%
\usepackage{graphicx}%
\usepackage{xcolor}%
\usepackage{booktabs}%
\usepackage{array}%
\usepackage{threeparttable}%
\usepackage{threeparttablex}%
\usepackage{siunitx}%
\usepackage{xurl}%
\usepackage{ragged2e}%
\usepackage[english]{babel}%
\usepackage[unicode]{hyperref}%
\usepackage{cleveref}%
\usepackage[most]{tcolorbox}%
\usepackage[acronym]{glossaries}% optional
\usepackage{fancyhdr}%
\usepackage{tabularx}%
\usepackage[autostyle=true]{csquotes}%
\usepackage[font=small,labelfont=bf]{caption}%
\captionsetup{justification=raggedright,singlelinecheck=false}%
\usepackage{placeins}%
\usepackage{float}%
\usepackage{doi}%
\usepackage{enumitem}%

% --- Column helpers ---
\newcolumntype{L}[1]{>{\RaggedRight\arraybackslash}p{#1}}%
\newcolumntype{Y}{>{\RaggedRight\arraybackslash}X}%

% --- PDF metadata ---
\hypersetup{%
  pdftitle   = {XXXXXXXXXX --- XXXXXXXXXX},
  pdfauthor  = {\AuthorName},
  pdfsubject = {XXXXXXXXXX},
  pdfkeywords= {X,X,X,...},
  colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue%
}%

% --- Page style + spacing ---
\pagestyle{fancy}%
\fancyhf{}%
\lhead{\PaperTitleMain}%
\rhead{\AuthorNameShort}%
\cfoot{\thepage}%
\setlength{\headheight}{14pt}%
\renewcommand{\headrulewidth}{0.3pt}%
\renewcommand{\footrulewidth}{0pt}%
\setlength{\textfloatsep}{12pt plus 2pt minus 2pt}%
\setlength{\intextsep}{10pt plus 2pt minus 2pt}%
\emergencystretch=2em%
\Urlmuskip=0mu plus 1mu%
\urlstyle{tt}%

% --- DOI helpers (clickable) ---
\providecommand{\doiurlprefix}{https://doi.org/}%
\renewcommand{\doi}[1]{\href{\doiurlprefix#1}{doi:\,#1}}%
\newcommand{\RepoDOIlink}{\href{https://doi.org/\RepoDOI}{\nolinkurl{https://doi.org/\RepoDOI}}}%

% --- Suggest a URL/DOI-aware BibTeX style by default ---
% Use in main.tex: \bibliographystyle{\DefaultBibStyle}
\IfFileExists{plainurl.bst}{%
  \providecommand{\DefaultBibStyle}{plainurl}% from urlbst; prints url+doi
}{%
  \providecommand{\DefaultBibStyle}{plain}% fallback if urlbst not installed
  \typeout{[format_macros] WARNING: plainurl.bst not found. URLs/DOIs may not appear with 'plain'.}%
}%

% --- Glossaries (optional) ---
\newif\ifwithglossary
\withglossarytrue
\ifwithglossary
  \makeglossaries
\fi
\makeatletter
\providecommand{\IfGlossariesEnabled}[1]{\@ifpackageloaded{glossaries}{#1}{}}%
\makeatother

% --- Breakable code/paths ---
\DeclareRobustCommand{\code}[1]{\nolinkurl{#1}}%

% --- Safe figure include (placeholder if missing) ---
\newcommand{\safeincludegraphics}[2][]{%
  \IfFileExists{#2}{\includegraphics[#1]{#2}}{%
    {\setlength{\fboxsep}{0pt}\fbox{\rule{0pt}{0.6in}\rule{0.9\linewidth}{0pt}}}%
    \typeout{[safeincludegraphics] Missing figure: #2}%
  }%
}%

% --- Provenance line (optional; 4th arg for notes) ---
\newcommand{\figprov}[4]{%
  \par\smallskip\noindent
  \begingroup\footnotesize\RaggedRight\sloppy\setlength{\emergencystretch}{12em}%
  \textit{Provenance:} src=\code{#1}; data=\code{#2}; commit=\code{#3}; #4.%
  \par\endgroup
}%

% --- Flat layout helpers ---
\providecommand{\src}[1]{src/#1}%
\providecommand{\data}[1]{data/#1}%
\providecommand{\fig}[1]{figs/#1}%

% --- siunitx defaults + small table helper ---
\sisetup{%
  reset-text-series = false, text-series-to-math = true,
  reset-text-family = false, text-family-to-math = true,
  group-minimum-digits = 4,
  round-mode = places, round-precision = 3%
}%
\newenvironment{smalltable}[1][]{\begin{threeparttable}[#1]\small}{\end{threeparttable}}%

% --- Claims & Tests table (compact) ---
\newenvironment{claimstable}{%
  \begingroup\footnotesize\sloppy\setlength{\emergencystretch}{2em}%
  \setlength{\tabcolsep}{2pt}%
  \renewcommand{\arraystretch}{1.07}%
  \begin{tabular}{@{}L{0.18\linewidth} L{0.34\linewidth} L{0.34\linewidth} L{0.08\linewidth}@{}}
  \toprule
  \textbf{Claim (Level)} & \textbf{Equation / Algorithm} & \textbf{Data \& Script} & \textbf{Pass} \\
  \midrule
}{%
  \\ \bottomrule
  \end{tabular}%
  \par\endgroup\smallskip
}%

% --- Level tags ---
\newcommand{\Lzero}{\textsf{L0}}%
\newcommand{\Lone}{\textsf{L1}}%
\newcommand{\Ltwo}{\textsf{L2}}%
\newcommand{\Lthree}{\textsf{L3}}%
\newcommand{\Lfour}{\textsf{L4}}%

% --- Non-Goals box ---
\newenvironment{nongoalsbox}{%
  \begin{tcolorbox}[colback=white,colframe=black!12,title=Non-Goals]
}{\end{tcolorbox}}%

% --- Lists toggle (LoF/LoT) ---
\newif\ifShowLists
\ShowListsfalse % set \ShowListsfalse to hide LoF/LoT