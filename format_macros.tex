% ==============================
% format_macros.tex — PDF figs; single DOI macro; link colors; bib+glossaries ON
% ==============================

% --- Core packages (pdfLaTeX-safe) ---
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{microtype}
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{array}
\usepackage{threeparttablex}
\usepackage{siunitx}
\usepackage{xurl}             % breakable URLs
\usepackage{ragged2e}         % \RaggedRight for tables/boxes
\usepackage[english]{babel}
\usepackage[unicode]{hyperref} % we color links explicitly
\usepackage{cleveref}
\usepackage[most]{tcolorbox}
\usepackage[acronym]{glossaries}
\usepackage{fancyhdr}
\usepackage{tabularx}
\usepackage[autostyle=true]{csquotes}
\usepackage[font=small,labelfont=bf]{caption}
\captionsetup{justification=raggedright,singlelinecheck=false}
\usepackage{placeins} % in preamble

% Force exact-here placement when needed
\usepackage{float}            % <-- added so [H] works reliably

% --- Column helpers ---
\newcolumntype{L}[1]{>{\RaggedRight\arraybackslash}p{#1}}
\newcolumntype{Y}{>{\RaggedRight\arraybackslash}X}

% --- Bibliography (ON) ---
\newif\ifshowbib
\showbibtrue
\ifshowbib
  \usepackage[
    backend=biber,
    style=numeric,
    sorting=none,
    maxnames=6,
    sortlocale=en,
    language=english
  ]{biblatex}
  \addbibresource{bibliography.bib}
\fi

% --- Identity ---
\providecommand{\PaperTitleMain}{Temporal Relativity — The Entropy Clock}
\providecommand{\PaperSubtitleMath}{$\Delta S = \kappa\,\Delta \tau$}
\providecommand{\AuthorName}{Christopher Michael Langstaff}
\providecommand{\AuthorNameShort}{C.~Langstaff}
\providecommand{\AuthorORCID}{0009-0000-3960-773X}
\providecommand{\PaperVersion}{v1.2}
\providecommand{\PaperLicense}{CC BY 4.0}
\providecommand{\RepoDOI}{10.5281/zenodo.17119050}
\providecommand{\RepoURL}{https://github.com/langstaffchristopherm-ops/Temporal_Relativity}
\providecommand{\RepoCommit}{v0.1.3}

% --- Eτ Law naming ---
\providecommand{\EtLawText}{E$\tau$~Law}
\providecommand{\EtLawPDF}{E-tau Law}
\providecommand{\EtLaw}{\textit{\EtLawText}}

% --- Page style + spacing ---
\pagestyle{fancy}
\fancyhf{}
\lhead{\PaperTitleMain}
\rhead{\AuthorNameShort}
\cfoot{\thepage}
\setlength{\headheight}{14pt}
\renewcommand{\headrulewidth}{0.3pt}
\renewcommand{\footrulewidth}{0pt}
\setlength{\textfloatsep}{12pt plus 2pt minus 2pt}
\setlength{\intextsep}{10pt plus 2pt minus 2pt}
\emergencystretch=2em
\Urlmuskip=0mu plus 1mu

% --- Figures: use explicit .pdf extension (your environment requires it) ---

% --- PDF metadata ---
\hypersetup{
  pdftitle   = {Temporal Relativity — The Entropy Clock},
  pdfauthor  = {\AuthorName},
  pdfsubject = {Entropy–Time proportionality; metric recovery; weak-field clocks},
  pdfkeywords= {E-tau Law, entropy-time, proper time, metric recovery, weak-field redshift}
}

% --- Link colors ---
\definecolor{linkblue}{HTML}{1A4E8A}
\definecolor{citeviolet}{HTML}{6B3FA0}
\definecolor{urlteal}{HTML}{0F766E}
\hypersetup{colorlinks=true, linkcolor=linkblue, citecolor=citeviolet, urlcolor=urlteal}

% --- Glossaries (ON) ---
\newif\ifwithglossary
\withglossarytrue
\ifwithglossary
  \makeglossaries
\fi

% --- Breakable code/paths ---
\urlstyle{tt}
\DeclareRobustCommand{\code}[1]{\nolinkurl{#1}}

% --- Unified DOI helpers (single canonical link) ---
\newcommand{\Doilink}[1]{\href{https://doi.org/#1}{\nolinkurl{https://doi.org/#1}}}
\newcommand{\RepoDOIlink}{\Doilink{\RepoDOI}}

% --- Safe figure include (placeholder if missing) ---
\newcommand{\safeincludegraphics}[2][]{%
  \IfFileExists{#2}{\includegraphics[#1]{#2}}{%
    {\setlength{\fboxsep}{0pt}\fbox{\rule{0pt}{0.6in}\rule{0.9\linewidth}{0pt}}}%
    \typeout{[safeincludegraphics] Missing figure: #2}}}

% --- Provenance line (no DOI here to avoid repetition) ---
\newcommand{\figprov}[4]{%
  \par\smallskip\noindent
  \begingroup\footnotesize\RaggedRight\sloppy\setlength{\emergencystretch}{12em}%
  \textit{Provenance:} src=\code{#1}; data=\code{#2}; commit=\code{#3}.%
  \par\endgroup
}

% --- Flat layout helpers ---
\providecommand{\src}[1]{src/#1}
\providecommand{\data}[1]{data/#1}
\providecommand{\fig}[1]{figs/#1}

% --- siunitx defaults + small table helper ---
\sisetup{
  reset-text-series = false, text-series-to-math = true,
  reset-text-family = false, text-family-to-math = true,
  group-minimum-digits = 4,
  round-mode = places, round-precision = 3
}
\newenvironment{smalltable}[1][]{\begin{threeparttable}[#1]\small}{\end{threeparttable}}

% --- Claims & Tests table (compact; no overfull) ---
\newenvironment{claimstable}{%
  \par\smallskip\noindent
  \begingroup\footnotesize\sloppy\setlength{\emergencystretch}{2em}%
  \setlength{\tabcolsep}{2pt}%
  \renewcommand{\arraystretch}{1.07}%
  \begin{tabular}{@{}L{0.18\linewidth} L{0.34\linewidth} L{0.34\linewidth} L{0.08\linewidth}@{}}
  \toprule
  \textbf{Claim (Level)} & \textbf{Equation / Algorithm} & \textbf{Data \& Script} & \textbf{Pass} \\
  \midrule
}{%
  \\ \bottomrule
  \end{tabular}%
  \par\endgroup\smallskip
}

% --- Level tags ---
\newcommand{\Lzero}{\textsf{L0}}
\newcommand{\Lone}{\textsf{L1}}
\newcommand{\Ltwo}{\textsf{L2}}
\newcommand{\Lthree}{\textsf{L3}}
\newcommand{\Lfour}{\textsf{L4}}

% --- Non-Goals box ---
\newenvironment{nongoalsbox}{%
  \begin{tcolorbox}[colback=white,colframe=black!12,title=Non-Goals]
}{\end{tcolorbox}}
